// ==UserScript==
// @name         Total Dark Mode (Violentmonkey)
// @namespace    https://violentmonkey.github.io/
// @version      4.0
// @description  Universal dark mode using full-page inversion with media correction and a persistent toggle.
// @match        *://*/*
// @grant        GM_addStyle
// @grant        GM_getValue
// @grant        GM_setValue
// @run-at       document-start
// ==/UserScript==

(function () {
    'use strict';

    const STORAGE_KEY = 'total-dark-mode-enabled';
    const HTML = document.documentElement;
    let buttonEl = null;

    const baseCSS = `
        html.vm-total-dark {
            background: #111 !important;
            filter: invert(1) hue-rotate(180deg) !important;
        }

        html.vm-total-dark body {
            background: transparent !important;
        }

        /* Re-invert media so photos/videos/icons stay natural while page chrome remains dark. */
        html.vm-total-dark img,
        html.vm-total-dark video,
        html.vm-total-dark picture,
        html.vm-total-dark canvas,
        html.vm-total-dark svg,
        html.vm-total-dark [style*="background-image"],
        html.vm-total-dark [style*="background: url"],
        html.vm-total-dark [class*="logo" i],
        html.vm-total-dark [id*="logo" i] {
            filter: invert(1) hue-rotate(180deg) !important;
        }

        /* Keep native form controls readable and consistent. */
        html.vm-total-dark input,
        html.vm-total-dark textarea,
        html.vm-total-dark select,
        html.vm-total-dark button {
            background-color: #1a1a1a !important;
            color: #ececec !important;
            border-color: #4a4a4a !important;
        }

        html.vm-total-dark input::placeholder,
        html.vm-total-dark textarea::placeholder {
            color: #a6a6a6 !important;
        }

        html.vm-total-dark,
        html.vm-total-dark * {
            scrollbar-color: #444 #111 !important;
        }

        html.vm-total-dark ::-webkit-scrollbar {
            width: 12px !important;
            height: 12px !important;
            background: #111 !important;
        }

        html.vm-total-dark ::-webkit-scrollbar-thumb {
            background: #444 !important;
            border-radius: 999px !important;
            border: 2px solid #111 !important;
        }

        #vm-total-dark-toggle {
            position: fixed;
            right: 16px;
            bottom: 16px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            background: #111;
            color: #fff;
            border: 1px solid #555;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            z-index: 2147483647;
            user-select: none;
            opacity: 0.75;
            transition: opacity 120ms ease;
        }

        #vm-total-dark-toggle:hover {
            opacity: 1;
        }

        /* Neutralize page inversion so toggle always looks normal. */
        html.vm-total-dark #vm-total-dark-toggle {
            filter: invert(1) hue-rotate(180deg) !important;
            background: #f0f0f0;
            color: #111;
            border-color: #bbb;
        }
    `;

    GM_addStyle(baseCSS);

    function getSavedState() {
        try {
            if (typeof GM_getValue === 'function') {
                return GM_getValue(STORAGE_KEY, true);
            }
        } catch (_) {
            // ignore and fallback
        }

        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return raw == null ? true : raw === 'true';
        } catch (_) {
            return true;
        }
    }

    function saveState(enabled) {
        try {
            if (typeof GM_setValue === 'function') {
                GM_setValue(STORAGE_KEY, enabled);
                return;
            }
        } catch (_) {
            // ignore and fallback
        }

        try {
            localStorage.setItem(STORAGE_KEY, String(enabled));
        } catch (_) {
            // ignored
        }
    }

    function setDarkMode(enabled) {
        HTML.classList.toggle('vm-total-dark', enabled);
        saveState(enabled);

        if (buttonEl) {
            buttonEl.textContent = enabled ? 'ðŸŒ™' : 'â˜€ï¸';
            buttonEl.title = enabled ? 'Disable dark mode' : 'Enable dark mode';
        }
    }

    function ensureToggleButton() {
        if (!document.body || document.getElementById('vm-total-dark-toggle')) {
            return;
        }

        buttonEl = document.createElement('button');
        buttonEl.id = 'vm-total-dark-toggle';
        buttonEl.type = 'button';
        buttonEl.setAttribute('aria-label', 'Toggle dark mode');
        buttonEl.addEventListener('click', () => {
            const enabled = HTML.classList.contains('vm-total-dark');
            setDarkMode(!enabled);
        });

        document.body.appendChild(buttonEl);

        const enabled = HTML.classList.contains('vm-total-dark');
        buttonEl.textContent = enabled ? 'ðŸŒ™' : 'â˜€ï¸';
        buttonEl.title = enabled ? 'Disable dark mode' : 'Enable dark mode';
    }

    setDarkMode(getSavedState());

    const domObserver = new MutationObserver(() => {
        ensureToggleButton();
    });

    domObserver.observe(document.documentElement, {
        childList: true,
        subtree: true,
    });

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ensureToggleButton, { once: true });
    } else {
        ensureToggleButton();
    }

    console.log('ðŸŒ‘ Total Dark Mode loaded (Violentmonkey v4.0)');
})();
