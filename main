// ==UserScript==
// @name         Total Dark Mode (Violentmonkey)
// @namespace    https://violentmonkey.github.io/
// @version      3.0
// @description  Aggressive whole-page dark mode for nearly every site with a persistent toggle.
// @match        *://*/*
// @grant        GM_addStyle
// @grant        GM_getValue
// @grant        GM_setValue
// @run-at       document-start
// ==/UserScript==

(function () {
    'use strict';

    const STORAGE_KEY = 'total-dark-mode-enabled';
    const HTML = document.documentElement;
    let buttonEl = null;

    const baseCSS = `
        html.vm-total-dark,
        html.vm-total-dark body {
            background: #000 !important;
            color: #e8e8e8 !important;
            color-scheme: dark !important;
        }

        html.vm-total-dark,
        html.vm-total-dark body,
        html.vm-total-dark body *:not(video):not(img):not(svg):not(canvas):not(picture):not(iframe):not(:hover):not(:active):not(:focus):not(:focus-within),
        html.vm-total-dark body *:not(video):not(img):not(svg):not(canvas):not(picture):not(iframe):not(:hover):not(:active):not(:focus):not(:focus-within)::before,
        html.vm-total-dark body *:not(video):not(img):not(svg):not(canvas):not(picture):not(iframe):not(:hover):not(:active):not(:focus):not(:focus-within)::after {
            background-color: #0a0a0a !important;
            background-image: none !important;
            color: #e8e8e8 !important;
            border-color: #3a3a3a !important;
            box-shadow: none !important;
            text-shadow: none !important;
            caret-color: #ffffff !important;
        }

        html.vm-total-dark body *:hover,
        html.vm-total-dark body *:active,
        html.vm-total-dark body *:focus,
        html.vm-total-dark body *:focus-within {
            transition-property: none !important;
        }

        html.vm-total-dark a,
        html.vm-total-dark a * {
            color: #7bb7ff !important;
        }

        html.vm-total-dark input,
        html.vm-total-dark textarea,
        html.vm-total-dark select,
        html.vm-total-dark button {
            background: #111 !important;
            color: #f3f3f3 !important;
            border: 1px solid #4a4a4a !important;
        }

        html.vm-total-dark input::placeholder,
        html.vm-total-dark textarea::placeholder {
            color: #9c9c9c !important;
        }

        html.vm-total-dark img,
        html.vm-total-dark video,
        html.vm-total-dark svg,
        html.vm-total-dark canvas,
        html.vm-total-dark picture,
        html.vm-total-dark iframe {
            filter: brightness(0.88) contrast(1.1) !important;
            background: transparent !important;
        }

        html.vm-total-dark [style*="background-image"]:not(:hover):not(:active):not(:focus):not(:focus-within),
        html.vm-total-dark [style*="linear-gradient"]:not(:hover):not(:active):not(:focus):not(:focus-within),
        html.vm-total-dark [style*="radial-gradient"]:not(:hover):not(:active):not(:focus):not(:focus-within) {
            background-image: none !important;
            background: #0f0f0f !important;
        }

        html.vm-total-dark ::selection {
            background: #225ea8 !important;
            color: #fff !important;
        }

        html.vm-total-dark ::-webkit-scrollbar {
            width: 12px !important;
            height: 12px !important;
            background: #050505 !important;
        }

        html.vm-total-dark ::-webkit-scrollbar-thumb {
            background: #3a3a3a !important;
            border-radius: 999px !important;
            border: 2px solid #0a0a0a !important;
        }

        html.vm-total-dark {
            scrollbar-color: #3a3a3a #050505 !important;
        }

        #vm-total-dark-toggle {
            position: fixed;
            right: 16px;
            bottom: 16px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            background: #111;
            color: #fff;
            border: 1px solid #555;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            z-index: 2147483647;
            user-select: none;
            opacity: 0.7;
            transition: opacity 120ms ease;
        }

        #vm-total-dark-toggle:hover {
            opacity: 1;
        }

        html.vm-total-dark #vm-total-dark-toggle {
            background: #f0f0f0;
            color: #111;
            border-color: #bbb;
        }
    `;

    GM_addStyle(baseCSS);

    function getSavedState() {
        try {
            if (typeof GM_getValue === 'function') {
                return GM_getValue(STORAGE_KEY, true);
            }
        } catch (_) {
            // ignore and fallback
        }

        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return raw == null ? true : raw === 'true';
        } catch (_) {
            return true;
        }
    }

    function saveState(enabled) {
        try {
            if (typeof GM_setValue === 'function') {
                GM_setValue(STORAGE_KEY, enabled);
                return;
            }
        } catch (_) {
            // ignore and fallback
        }

        try {
            localStorage.setItem(STORAGE_KEY, String(enabled));
        } catch (_) {
            // ignored
        }
    }

    function setDarkMode(enabled) {
        HTML.classList.toggle('vm-total-dark', enabled);
        saveState(enabled);

        if (buttonEl) {
            buttonEl.textContent = enabled ? 'ðŸŒ™' : 'â˜€ï¸';
            buttonEl.title = enabled ? 'Disable dark mode' : 'Enable dark mode';
        }
    }

    function ensureToggleButton() {
        if (!document.body || document.getElementById('vm-total-dark-toggle')) {
            return;
        }

        buttonEl = document.createElement('button');
        buttonEl.id = 'vm-total-dark-toggle';
        buttonEl.type = 'button';
        buttonEl.setAttribute('aria-label', 'Toggle dark mode');
        buttonEl.addEventListener('click', () => {
            const enabled = HTML.classList.contains('vm-total-dark');
            setDarkMode(!enabled);
        });

        document.body.appendChild(buttonEl);

        const enabled = HTML.classList.contains('vm-total-dark');
        buttonEl.textContent = enabled ? 'ðŸŒ™' : 'â˜€ï¸';
        buttonEl.title = enabled ? 'Disable dark mode' : 'Enable dark mode';
    }

    const initiallyEnabled = getSavedState();
    setDarkMode(initiallyEnabled);

    const domObserver = new MutationObserver(() => {
        if (!document.body || !HTML.classList.contains('vm-total-dark')) {
            return;
        }
        ensureToggleButton();
    });

    domObserver.observe(document.documentElement, {
        childList: true,
        subtree: true,
    });

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ensureToggleButton, { once: true });
    } else {
        ensureToggleButton();
    }

    console.log('ðŸŒ‘ Total Dark Mode loaded (Violentmonkey)');
})();
